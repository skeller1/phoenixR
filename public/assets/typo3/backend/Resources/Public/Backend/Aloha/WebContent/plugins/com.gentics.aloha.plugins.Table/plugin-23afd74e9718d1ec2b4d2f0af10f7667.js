/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
/********************************
  +---------------------------+
  | GENTICS.Aloha.TablePlugin |
  +---------------------------+
 ********************************/
/**
 * Register the TablePlugin as GENTICS.Aloha.Plugin
 */
GENTICS.Aloha.TablePlugin=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.Table"),GENTICS.Aloha.TablePlugin.createLayer=undefined,GENTICS.Aloha.TablePlugin.languages=["en","de","fr","eo","fi","ru","it","pl"],GENTICS.Aloha.TablePlugin.config=["table"],GENTICS.Aloha.TablePlugin.TableRegistry=[],GENTICS.Aloha.TablePlugin.activeTable=undefined,GENTICS.Aloha.TablePlugin.parameters={className:"GENTICS_Aloha_Table",classSelectionRow:"GENTICS_Aloha_Table_selectColumn",classSelectionColumn:"GENTICS_Aloha_Table_selectRow",classLeftUpperCorner:"GENTICS_Aloha_Table_leftUpperCorner",classTableWrapper:"GENTICS_Aloha_Table_wrapper",classCellSelected:"GENTICS_Aloha_Cell_selected",waiRed:"GENTICS_WAI_RED",waiGreen:"GENTICS_WAI_GREEN",selectionArea:10},GENTICS.Aloha.TablePlugin.init=function(){this.createLayer=new GENTICS.Aloha.Table.CreateLayer;var a=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableCreated",function(b,c){c.obj.bind("mousedown",function(a){GENTICS.Aloha.TablePlugin.setFocusedTable(undefined)}),c.obj.find("table").each(function(){if(a.isEditableTable(this)){var b=new GENTICS.Aloha.Table(this);b.parentEditable=c,GENTICS.Aloha.TablePlugin.TableRegistry.push(b)}})}),this.initTableButtons(),GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"selectionChanged",function(b,c){if(GENTICS.Aloha.activeEditable){var d=a.getEditableConfig(GENTICS.Aloha.activeEditable.obj);jQuery.inArray("table",d)!=-1&&GENTICS.Aloha.Selection.mayInsertTag("table")?a.createTableButton.show():a.createTableButton.hide(),GENTICS.Aloha.TableHelper.unselectCells();var e=c.findMarkup(function(){return this.nodeName.toLowerCase()=="table"},GENTICS.Aloha.activeEditable.obj);e?GENTICS.Aloha.FloatingMenu.setScope(a.getUID(GENTICS.Aloha.TableHelper.selectionType)):a.activeTable&&a.activeTable.focusOut(),GENTICS.Aloha.FloatingMenu.doLayout()}}),GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableActivated",function(b,c){c.editable.obj.find("table").each(function(){var b=GENTICS.Aloha.TablePlugin.TableRegistry;for(var d=0;d<b.length;d++)if(b[d].obj.attr("id")==jQuery(this).attr("id"))return b[d].activate(),!0;if(a.isEditableTable(this)){var e=new GENTICS.Aloha.Table(this);e.parentEditable=c.editable,e.activate(),GENTICS.Aloha.TablePlugin.TableRegistry.push(e)}})}),GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableDeactivated",function(a,b){GENTICS.Aloha.TablePlugin.setFocusedTable(undefined),GENTICS.Aloha.TableHelper.unselectCells();var c=GENTICS.Aloha.TablePlugin.TableRegistry;for(var d=0;d<c.length;d++)c[d].deactivate()})},GENTICS.Aloha.TablePlugin.isEditableTable=function(a){var b=jQuery(a.parentNode);return b.contentEditable()=="true"?!0:!1},GENTICS.Aloha.TablePlugin.initTableButtons=function(){var a=this;GENTICS.Aloha.FloatingMenu.createScope(this.getUID("row"),"GENTICS.Aloha.global"),GENTICS.Aloha.FloatingMenu.createScope(this.getUID("column"),"GENTICS.Aloha.global"),GENTICS.Aloha.FloatingMenu.createScope(this.getUID("cell"),"GENTICS.Aloha.continuoustext"),this.createTableButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_table",size:"small",tooltip:this.i18n("button.createtable.tooltip"),onclick:function(a,b){GENTICS.Aloha.TablePlugin.createDialog(a.btnEl.dom)}}),GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.createTableButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("column"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addColumnLeft",size:"small",tooltip:this.i18n("button.addcolleft.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addColumnsLeft()}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("column"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addColumnRight",size:"small",tooltip:this.i18n("button.addcolright.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addColumnsRight()}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("column"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_deleteColumns",size:"small",tooltip:this.i18n("button.delcols.tooltip"),onclick:function(){if(a.activeTable){var b=a.activeTable;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(a,"Table"),text:GENTICS.Aloha.i18n(a,"deletecolumns.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(a){a=="yes"&&b.deleteColumns()}}))}}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("row"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addRowBefore",size:"small",tooltip:this.i18n("button.addrowbefore.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addRowsBefore(!0)}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("row"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addRowAfter",size:"small",tooltip:this.i18n("button.addrowafter.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addRowsAfter(!0)}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("row"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_deleteRows",size:"small",tooltip:this.i18n("button.delrows.tooltip"),onclick:function(){if(a.activeTable){var b=a.activeTable;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(a,"Table"),text:GENTICS.Aloha.i18n(a,"deleterows.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(a){a=="yes"&&b.deleteRows()}}))}}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),this.captionButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_table_caption",size:"small",tooltip:this.i18n("button.caption.tooltip"),toggle:!0,onclick:function(){if(a.activeTable)if(a.activeTable.obj.children("caption").is("caption"))a.activeTable.obj.children("caption").remove();else{var b=a.i18n("empty.caption"),c=jQuery("<caption></caption>");a.activeTable.obj.append(c),a.makeCaptionEditable(c,b);var d=c.find("div").eq(0),e=d.contents().eq(0);if(e.length>0){var f=new GENTICS.Utils.RangeObject;f.startContainer=f.endContainer=e.get(0),f.startOffset=0,f.endOffset=e.text().length,a.activeTable.obj.find("div.GENTICS_Table_Cell_editable").blur(),d.focus(),f.select(),GENTICS.Aloha.Selection.updateSelection()}}}}),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("cell"),this.captionButton,GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1),this.summary=new GENTICS.Aloha.ui.AttributeField({width:350}),this.summary.addListener("keyup",function(b,c){a.activeTable.checkWai()}),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("cell"),this.summary,GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1)},GENTICS.Aloha.TablePlugin.makeCaptionEditable=function(a,b){var c=this,d=a.children("div").eq(0);d.length==0&&(d=jQuery("<div></div>"),a.contents().length>0?a.contents().wrap(d):(b&&d.text(b),a.append(d))),d.contentEditable(!0),d.unbind("mousedown"),d.bind("mousedown",function(a){return d.focus(),a.preventDefault(),a.stopPropagation(),!1})},GENTICS.Aloha.TablePlugin.createDialog=function(a){this.createLayer.set("target",a),this.createLayer.show()},GENTICS.Aloha.TablePlugin.createTable=function(a,b){if(GENTICS.Aloha.activeEditable!=null&&typeof GENTICS.Aloha.activeEditable.obj!="undefined"){var c=document.createElement("table"),d=c.id=GENTICS.Aloha.TableHelper.getNewTableID(),e=document.createElement("tbody");for(var f=0;f<b;f++){var g=document.createElement("tr");for(var h=0;h<a;h++){var i=document.createTextNode(" "),j=document.createElement("td");j.appendChild(i),g.appendChild(j)}e.appendChild(g)}c.appendChild(e),GENTICS.Utils.Dom.insertIntoDOM(jQuery(c),GENTICS.Aloha.Selection.getRangeObject(),jQuery(GENTICS.Aloha.activeEditable.obj));var k=document.getElementById(d),l=new GENTICS.Aloha.Table(k);l.parentEditable=GENTICS.Aloha.activeEditable,l.activate(),jQuery.browser.msie?window.setTimeout(function(){l.cells[0].wrapper.get(0).focus()},20):l.cells[0].wrapper.get(0).focus(),GENTICS.Aloha.TablePlugin.TableRegistry.push(l)}else this.error("There is no active Editable where the table can be inserted!")},GENTICS.Aloha.TablePlugin.setFocusedTable=function(a){var b=this;for(var c=0;c<GENTICS.Aloha.TablePlugin.TableRegistry.length;c++)GENTICS.Aloha.TablePlugin.TableRegistry[c].hasFocus=!1;if(typeof a!="undefined"){this.summary.setTargetObject(a.obj,"summary");if(a.obj.children("caption").is("caption")){b.captionButton.setPressed(!0);var d=a.obj.children("caption");b.makeCaptionEditable(d)}a.hasFocus=!0}GENTICS.Aloha.TablePlugin.activeTable=a},GENTICS.Aloha.TablePlugin.error=function(a){GENTICS.Aloha.Log.error(this,a)},GENTICS.Aloha.TablePlugin.debug=function(a){GENTICS.Aloha.Log.debug(this,a)},GENTICS.Aloha.TablePlugin.info=function(a){GENTICS.Aloha.Log.info(this,a)},GENTICS.Aloha.TablePlugin.log=function(a){GENTICS.Aloha.log("log",this,a)},GENTICS.Aloha.TablePlugin.get=function(a){return this.config[a]?this.config[a]:this.parameters[a]?this.parameters[a]:undefined},GENTICS.Aloha.TablePlugin.set=function(a,b){this.config[a]?this.config[a]=b:this.parameters[a]=b},GENTICS.Aloha.TablePlugin.makeClean=function(a){a.find("table").each(function(){var a=new GENTICS.Aloha.Table(this);a.deactivate()})},GENTICS.Aloha.TablePlugin.toString=function(){return this.prefix},GENTICS.Aloha.Table=function(a){this.obj=jQuery(a),this.obj.attr("id")||this.obj.attr("id",GENTICS.Utils.guid());var b=this.obj.find("tr"),c=jQuery(b.get(0));this.numCols=c.children("td, th").length,this.numRows=b.length,this.cells=[];var b=this.obj.find("tr");for(var d=0;d<b.length;d++){var e=jQuery(b[d]),f=e.children();for(var g=0;g<f.length;g++){var h=f[g],i=new GENTICS.Aloha.Table.Cell(h,this);this.cells.push(i)}}},GENTICS.Aloha.Table.prototype.obj=undefined,GENTICS.Aloha.Table.prototype.tableWrapper=undefined,GENTICS.Aloha.Table.prototype.cells=undefined,GENTICS.Aloha.Table.prototype.numRows=undefined,GENTICS.Aloha.Table.prototype.numCols=undefined,GENTICS.Aloha.Table.prototype.isActive=!1,GENTICS.Aloha.Table.prototype.hasFocus=!1,GENTICS.Aloha.Table.prototype.parentEditable=undefined,GENTICS.Aloha.Table.prototype.mousedown=!1,GENTICS.Aloha.Table.prototype.clickedColumnId=-1,GENTICS.Aloha.Table.prototype.clickedRowId=-1,GENTICS.Aloha.Table.prototype.columnsToSelect=[],GENTICS.Aloha.Table.prototype.rowsToSelect=[],GENTICS.Aloha.Table.prototype.fmPluginId=undefined,GENTICS.Aloha.Table.prototype.get=function(a){return GENTICS.Aloha.TablePlugin.get(a)},GENTICS.Aloha.Table.prototype.set=function(a,b){GENTICS.Aloha.TablePlugin.set(a,b)},GENTICS.Aloha.Table.prototype.activate=function(){if(this.isActive)return;var a=this;this.obj.addClass(this.get("className")),this.obj.contentEditable(!1),this.obj.attr("id")==""&&this.obj.attr("id",GENTICS.Aloha.TableHelper.getNewTableID()),GENTICS.Aloha.TableHelper.selectionType=undefined,this.obj.bind("keydown",function(a){!a.ctrlKey&&!a.shiftKey&&GENTICS.Aloha.TableHelper.selectedCells.length>0&&GENTICS.Aloha.TableHelper.selectedCells[0].length>0&&GENTICS.Aloha.TableHelper.selectedCells[0][0].firstChild.focus()}),this.obj.bind("mousedown",function(b){return a.hasFocus||a.focus(),b.stopPropagation(),b.preventDefault(),!1});var b=jQuery('<div class="'+this.get("classTableWrapper")+'"></div>');b.contentEditable(!1),this.obj.wrap(b);var c=this.obj.parents("."+this.get("classTableWrapper"));c.get(0).onresizestart=function(a){return!1},c.get(0).oncontrolselect=function(a){return!1},this.tableWrapper=this.obj.parents("."+this.get("classTableWrapper")).get(0),jQuery(this.cells).each(function(){this.activate()}),this.attachSelectionColumn(),this.attachSelectionRow(),this.attachLastCellEvents(),this.makeCaptionEditable(),this.checkWai(),this.isActive=!0,GENTICS.Aloha.EventRegistry.trigger(new GENTICS.Aloha.Event("tableActivated",GENTICS.Aloha,[this]))},GENTICS.Aloha.Table.prototype.makeCaptionEditable=function(){var a=this.obj.find("caption").eq(0);a&&GENTICS.Aloha.TablePlugin.makeCaptionEditable(a)},GENTICS.Aloha.Table.prototype.checkWai=function(){var a=this.wai;a.removeClass(this.get("waiGreen")),a.removeClass(this.get("waiRed")),this.obj[0].summary.length>5?a.addClass(this.get("waiGreen")):a.addClass(this.get("waiRed"))},GENTICS.Aloha.Table.prototype.attachSelectionColumn=function(){var a=jQuery("<td>");a.html(" ");var b=this,c=this.obj.context.rows;for(var d=0;d<c.length;d++){var e=jQuery(c[d]),f=a.clone();f.addClass(this.get("classSelectionColumn")),f.css("width",this.get("selectionArea")+"px"),e.find("td:first").before(f);var g=d+1;this.attachRowSelectionEventsToCell(f)}},GENTICS.Aloha.Table.prototype.attachRowSelectionEventsToCell=function(a){var b=this;a.unbind("mousedown"),a.unbind("mouseover"),a.get(0).onselectstart=function(){return!1},a.bind("mousedown",function(a){return b.mousedown=!0,b.rowSelectionMouseDown(a)}),a.bind("mouseover",function(a){if(b.mousedown)return b.rowSelectionMouseOver(a)})},GENTICS.Aloha.Table.prototype.rowSelectionMouseDown=function(a){this.focus(),GENTICS.Aloha.TableHelper.selectedCells.length==0&&(this.rowsToSelect=[]),this.clickedRowId=a.currentTarget.parentNode.rowIndex;if(a.metaKey){var b=jQuery.inArray(this.clickedRowId,this.rowsToSelect);b>=0?this.rowsToSelect.splice(b,1):this.rowsToSelect.push(this.clickedRowId)}else if(a.shiftKey){this.rowsToSelect.sort(function(a,b){return a-b});var c=this.rowsToSelect[0],d=this.clickedRowId;c>d&&(c=d,d=this.rowsToSelect[0]),this.rowsToSelect=[];for(var e=c;e<=d;e++)this.rowsToSelect.push(e)}else this.rowsToSelect=[this.clickedRowId];return this.selectRows(),a.preventDefault(),a.stopPropagation(),!1},GENTICS.Aloha.Table.prototype.rowSelectionMouseOver=function(a){var b=a.currentTarget.parentNode.rowIndex;if(this.mousedown&&this.clickedRowId>=0){var c=jQuery.inArray(b,this.rowsToSelect),d=b<this.clickedRowId?b:this.clickedRowId,e=b<this.clickedRowId?this.clickedRowId:b;this.rowsToSelect=[];for(var f=d;f<=e;f++)this.rowsToSelect.push(f);return this.selectRows(),a.preventDefault(),a.stopPropagation(),!1}},GENTICS.Aloha.Table.prototype.attachSelectionRow=function(){var a=this,b=jQuery("<td>");b.html(" ");var c=this.obj.context.rows[0].cells.length,d=jQuery("<tr>");d.addClass(this.get("classSelectionRow")),d.css("height",this.get("selectionArea")+"px");for(var e=0;e<c;e++){var f=b.clone();if(e>0)this.attachColumnSelectEventsToCell(f);else{var f=jQuery("<td>").clone();f.addClass(this.get("classLeftUpperCorner")),this.wai=jQuery("<div/>"),this.wai.width(25),this.wai.height(12),this.wai.click(function(b){return a.focus(),GENTICS.Aloha.FloatingMenu.userActivatedTab=GENTICS.Aloha.TablePlugin.i18n("floatingmenu.tab.table"),GENTICS.Aloha.FloatingMenu.doLayout(),GENTICS.Aloha.TablePlugin.summary.focus(),b.stopPropagation(),b.preventDefault(),!1}),f.append(this.wai)}d.append(f)}jQuery(document).bind("mouseup",function(b){a.mousedown=!1,a.clickedColumnId=-1,a.clickedRowId=-1}),this.obj.find("tr:first").before(d)},GENTICS.Aloha.Table.prototype.attachColumnSelectEventsToCell=function(a){var b=this;a.unbind("mousedown"),a.unbind("mouseover"),a.get(0).onselectstart=function(){return!1},a.bind("mousedown",function(a){b.mousedown=!0,b.columnSelectionMouseDown(a)}),a.bind("mouseover",function(a){b.mousedown&&b.columnSelectionMouseOver(a)})},GENTICS.Aloha.Table.prototype.columnSelectionMouseDown=function(a){this.focus(),GENTICS.Aloha.TableHelper.selectedCells.length==0&&(this.columnsToSelect=[]),this.clickedColumnId=a.currentTarget.cellIndex;if(a.metaKey){var b=jQuery.inArray(this.clickedColumnId,this.columnsToSelect);b>=0?this.columnsToSelect.splice(b,1):this.columnsToSelect.push(this.clickedColumnId)}else if(a.shiftKey){this.columnsToSelect.sort(function(a,b){return a-b});var c=this.columnsToSelect[0],d=this.clickedColumnId;c>d&&(c=d,d=this.columnsToSelect[0]),this.columnsToSelect=[];for(var e=c;e<=d;e++)this.columnsToSelect.push(e)}else this.columnsToSelect=[this.clickedColumnId];return this.selectColumns(),a.preventDefault(),a.stopPropagation(),!1},GENTICS.Aloha.Table.prototype.columnSelectionMouseOver=function(a){var b=a.currentTarget.cellIndex;if(this.mousedown&&this.clickedColumnId>0){var c=jQuery.inArray(b,this.columnsToSelect),d=b<this.clickedColumnId?b:this.clickedColumnId,e=b<this.clickedColumnId?this.clickedColumnId:b;this.columnsToSelect=[];for(var f=d;f<=e;f++)this.columnsToSelect.push(f);this.selectColumns()}},GENTICS.Aloha.Table.prototype.releaseLastCellEvents=function(){this.obj.find("tr:last td:last").unbind()},GENTICS.Aloha.Table.prototype.attachLastCellEvents=function(){var a=this;this.obj.find("tr:last td:last").bind("keydown",function(b){a.lastCellKeyDown(b)})},GENTICS.Aloha.Table.prototype.lastCellKeyDown=function(a){var b=9;if(b==a.keyCode&&!a.altKey&&!a.shiftKey&&!a.ctrlKey){this.addRowsAfter(!1),a.stopPropagation();if(jQuery.browser.msie)return this.obj.find("tr:last td:nth-child(1) div.GENTICS_Table_Cell_editable").get(0).focus(),!1}},GENTICS.Aloha.Table.prototype.deleteRows=function(){var a=[],b=!1;if(GENTICS.Aloha.TableHelper.selectedCells.length>0)for(var c=0;c<GENTICS.Aloha.TableHelper.selectedCells.length;c++)a.push(GENTICS.Aloha.TableHelper.selectedCells[c][0].parentNode.rowIndex);else typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined"&&a.push(GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.parentNode.rowIndex);a.length==this.numRows&&(b=!0);if(b){var d=this;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,"Table"),text:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,"deletetable.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(a){a=="yes"&&d.deleteTable()}}))}else{a.sort(function(a,b){return a-b});var e=a[0];e>this.numRows-a.length&&e--,this.releaseLastCellEvents();var f=this.obj.find("tr"),g=[];for(var c=0;c<a.length;c++)g.push(jQuery(f[a[c]]));for(var c=0;c<g.length;c++){var h=g[c].children("td").toArray();for(var i=0;i<h.length;i++)for(var j=0;j<this.cells.length;j++)h[i]==this.cells[j].obj.get(0)&&(this.cells.splice(j,1),j=this.cells.length)}for(var c=0;c<g.length;c++)g[c].remove();this.numRows-=g.length,jQuery.browser.msie?setTimeout(this.obj.find("tr:nth-child("+(e+1)+") td:nth-child(2) div.GENTICS_Table_Cell_editable").get(0).focus,5):this.obj.find("tr:nth-child("+(e+1)+") td:nth-child(2) div.GENTICS_Table_Cell_editable").get(0).focus(),this.attachLastCellEvents(),GENTICS.Aloha.TableHelper.unselectCells()}},GENTICS.Aloha.Table.prototype.deleteColumns=function(){var a=[],b=!1;if(GENTICS.Aloha.TableHelper.selectedCells.length>0)for(var c=0;c<GENTICS.Aloha.TableHelper.selectedCells[0].length;c++)a.push(GENTICS.Aloha.TableHelper.selectedCells[0][c].cellIndex);else typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined"&&a.push(GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.cellIndex);a.length==this.numCols&&(b=!0);if(b){var d=this;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,"Table"),text:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,"deletetable.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(a){a=="yes"&&d.deleteTable()}}))}else{a.sort(function(a,b){return a-b});var e=a[0];e>this.numCols-a.length&&e--,this.releaseLastCellEvents();var f=this.obj.find("tr"),g=[];for(var c=0;c<f.length;c++){var h=jQuery(f[c]).children("td").toArray();for(var i=0;i<a.length;i++)g.push(h[a[i]])}for(var c=0;c<g.length;c++)for(var i=0;i<this.cells.length;i++)g[c]==this.cells[i].obj.get(0)&&(this.cells.splice(i,1),i=this.cells.length);for(var c=0;c<g.length;c++)jQuery(g[c]).remove();this.numCols-=a.length,jQuery.browser.msie?setTimeout(this.obj.find("tr:nth-child(2) td:nth-child("+(e+1)+") div.GENTICS_Table_Cell_editable").get(0).focus,5):this.obj.find("tr:nth-child(2) td:nth-child("+(e+1)+") div.GENTICS_Table_Cell_editable").get(0).focus(),this.attachLastCellEvents(),GENTICS.Aloha.TableHelper.unselectCells()}},GENTICS.Aloha.Table.prototype.deleteTable=function(){var a=-1;for(var b=0;b<GENTICS.Aloha.TablePlugin.TableRegistry.length;b++)if(GENTICS.Aloha.TablePlugin.TableRegistry[b].obj.attr("id")==this.obj.attr("id")){a=b;break}if(a>=0){this.deactivate(),GENTICS.Aloha.TableHelper.selectionType=undefined,GENTICS.Aloha.TablePlugin.TableRegistry.splice(b,1);var c=GENTICS.Aloha.Selection.rangeObject;c.startContainer=c.endContainer=this.obj.get(0).parentNode,c.startOffset=c.endOffset=GENTICS.Utils.Dom.getIndexInParent(this.obj.get(0).parentNode),c.clearCaches(),this.obj.remove(),this.parentEditable.obj.focus(),c.correctRange(),c.select()}},GENTICS.Aloha.Table.prototype.addRowsBefore=function(a){this.addRows("before",a)},GENTICS.Aloha.Table.prototype.addRowsAfter=function(a){this.addRows("after",a)},GENTICS.Aloha.Table.prototype.addRows=function(a,b){if(typeof GENTICS.Aloha.TablePlugin.activeTable!="undefined"){this.releaseLastCellEvents();var c=this,d=this.numCols,e=1,f=1;if(GENTICS.Aloha.TableHelper.selectedCells.length>0){e=GENTICS.Aloha.TableHelper.selectedCells.length;switch(a){case"before":GENTICS.Aloha.TableHelper.selectedCells[0].length&&(f=GENTICS.Aloha.TableHelper.selectedCells[0][0].parentNode.rowIndex);break;case"after":var g=GENTICS.Aloha.TableHelper.selectedCells.length-1;GENTICS.Aloha.TableHelper.selectedCells[g].length&&(f=GENTICS.Aloha.TableHelper.selectedCells[g][0].parentNode.rowIndex)}}else typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined"&&(f=GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.parentNode.rowIndex);var h=f;a=="after"&&(h+=1);var j=[];for(var k=0;k<e;k++){j.push(h);var l=jQuery("<tr>"),m=jQuery("<td>");m.addClass(this.get("classSelectionColumn")),this.attachRowSelectionEventsToCell(m),l.append(m);for(i=0;i<d;i++){var n=jQuery("<td>");n.html(" ");var o=new GENTICS.Aloha.Table.Cell(n.get(0),GENTICS.Aloha.TablePlugin.activeTable);o.activate(),this.cells.push(o),l.append(o.obj)}var p=jQuery(GENTICS.Aloha.TablePlugin.activeTable.obj.find("tr").get(f));switch(a){case"before":p.before(l);break;case"after":p.after(l);break;default:this.warn(this,"Wrong call of GENTICS.Aloha.Table.prototype.addRow!")}h++,this.numRows++}GENTICS.Aloha.TableHelper.unselectCells(),this.rowsToSelect=j,b&&this.selectRows(),this.attachLastCellEvents()}},GENTICS.Aloha.Table.prototype.addColumnsRight=function(){this.addColumns("right")},GENTICS.Aloha.Table.prototype.addColumnsLeft=function(){this.addColumns("left")},GENTICS.Aloha.Table.prototype.addColumns=function(a){if(typeof GENTICS.Aloha.TablePlugin.activeTable!="undefined"){this.releaseLastCellEvents();var b=this,c=1,d=1;if(GENTICS.Aloha.TableHelper.selectedCells.length>0){c=GENTICS.Aloha.TableHelper.selectedCells[0].length;switch(a){case"left":GENTICS.Aloha.TableHelper.selectedCells[0].length&&(d=GENTICS.Aloha.TableHelper.selectedCells[0][0].cellIndex);break;case"right":var e=GENTICS.Aloha.TableHelper.selectedCells[0].length-1;GENTICS.Aloha.TableHelper.selectedCells[0].length&&(d=GENTICS.Aloha.TableHelper.selectedCells[0][e].cellIndex)}}else typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined"&&(d=GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.cellIndex);var f=d,g=jQuery("<td>"),h=this.obj.find("tr"),i=[];for(var j=0;j<h.length;j++){var k=f,l=h[j];for(var m=0;m<c;m++){var n=g.clone();n.html(" "),j==0?this.attachColumnSelectEventsToCell(n):(cellObj=new GENTICS.Aloha.Table.Cell(n.get(0),GENTICS.Aloha.TablePlugin.activeTable),this.cells.push(cellObj),cellObj.activate(),n=cellObj.obj);var o=jQuery(jQuery(l).find("td").get(f));switch(a){case"left":jQuery.inArray(k,i)<0&&i.push(k),o.before(n);break;case"right":jQuery.inArray(k+1,i)<0&&i.push(k+1),o.after(n)}k++}}this.numCols+=c,GENTICS.Aloha.TableHelper.unselectCells(),this.columnsToSelect=i,this.selectColumns(),this.attachLastCellEvents()}},GENTICS.Aloha.Table.prototype.focus=function(){this.hasFocus||(this.parentEditable.isActive||this.parentEditable.obj.focus(),GENTICS.Aloha.TablePlugin.setFocusedTable(this))},GENTICS.Aloha.Table.prototype.focusOut=function(){this.hasFocus&&(GENTICS.Aloha.TablePlugin.setFocusedTable(undefined),GENTICS.Aloha.TableHelper.selectionType=undefined)},GENTICS.Aloha.Table.prototype.selectColumns=function(){var a=this.get("classCellSelected");GENTICS.Aloha.TableHelper.unselectCells(),GENTICS.Aloha.TableHelper.selectionType="column",GENTICS.Aloha.FloatingMenu.setScope(GENTICS.Aloha.TablePlugin.getUID("column")),this.columnsToSelect.sort(function(a,b){return a-b});var b=this.obj.find("tr").toArray();b.shift();var c=[];for(var d=0;d<b.length;d++){var e=b[d].cells,f=[];for(var g=0;g<this.columnsToSelect.length;g++){var h=this.columnsToSelect[g],i=e[h];c.push(i),f.push(i)}GENTICS.Aloha.TableHelper.selectedCells.push(f)}this.obj.find("div.GENTICS_Table_Cell_editable").blur(),jQuery(c).addClass(a)},GENTICS.Aloha.Table.prototype.selectRows=function(){var a=this.get("classCellSelected");GENTICS.Aloha.TableHelper.unselectCells(),this.rowsToSelect.sort(function(a,b){return a-b});for(var b=0;b<this.rowsToSelect.length;b++){var c=this.rowsToSelect[b],d=jQuery(this.obj.find("tr").get(c).cells).toArray();d.shift(),GENTICS.Aloha.TableHelper.selectedCells.push(d),jQuery(d).addClass(this.get("classCellSelected"))}GENTICS.Aloha.TableHelper.selectionType="row",GENTICS.Aloha.FloatingMenu.setScope(GENTICS.Aloha.TablePlugin.getUID("row")),this.obj.find("div.GENTICS_Table_Cell_editable").blur()},GENTICS.Aloha.Table.prototype.deactivate=function(){this.obj.removeClass(this.get("className")),GENTICS.Aloha.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class"),this.obj.parents("."+this.get("classTableWrapper")).length&&this.obj.unwrap(),this.obj.find("tr."+this.get("classSelectionRow")+":first").remove();var a=this;jQuery.each(this.obj.context.rows,function(){jQuery(this).children("td."+a.get("classSelectionColumn")).remove()}),this.obj.find("td, th").removeClass(this.get("classCellSelected")),this.obj.unbind();for(var b=0;b<this.cells.length;b++){var c=this.cells[b];c.deactivate()}this.obj.find("caption div").each(function(){jQuery(this).contents().unwrap()}),this.isActive=!1},GENTICS.Aloha.Table.prototype.toString=function(){return"GENTICS.Aloha.Table"},GENTICS.Aloha.Table.Cell=function(a,b){this.obj=jQuery(a),this.tableObj=b},GENTICS.Aloha.Table.Cell.prototype.tableObj=undefined,GENTICS.Aloha.Table.Cell.prototype.obj=undefined,GENTICS.Aloha.Table.Cell.prototype.wrapper=undefined,GENTICS.Aloha.Table.Cell.prototype.hasFocus=!1,GENTICS.Aloha.Table.Cell.activeCell=undefined,GENTICS.Aloha.Table.Cell.lastActiveCell=undefined,GENTICS.Aloha.Table.Cell.prototype.editableFocus=function(a){this.hasFocus||(this.tableObj.focus(),GENTICS.Aloha.Table.Cell.activeCell=this,GENTICS.Aloha.Table.Cell.lastActiveCell=this,this.obj.addClass("GENTICS_Table_Cell_active"),this.hasFocus=!0,this.selectAll(this.wrapper.get(0)),GENTICS.Aloha.TableHelper.selectionType="cell")},GENTICS.Aloha.Table.Cell.prototype.editableBlur=function(a){GENTICS.Aloha.Table.Cell.activeCell=undefined,this.hasFocus=!1,this.obj.removeClass("GENTICS_Table_Cell_active")},GENTICS.Aloha.Table.Cell.prototype.activate=function(){this.obj.wrapInner("<div/>");var a=this.obj.children("div").eq(0);a.contentEditable(!0),a.addClass("GENTICS_Table_Cell_editable");var b=this;return a.bind("focus",function(a){a.currentTarget&&(a.currentTarget.indexOf=function(){return-1}),b.editableFocus(a)}),a.bind("mousedown",function(a){a.currentTarget&&(a.currentTarget.indexOf=function(){return-1}),b.editableMouseDown(a)}),a.bind("blur",function(a){b.editableBlur(a)}),a.bind("keyup",function(a){b.editableKeyUp(a)}),a.bind("keydown",function(a){b.editableKeyDown(a)}),a.GENTICS_contentEditableSelectionChange(function(b){return GENTICS.Aloha.Selection.onChange(a,b),a}),this.obj.bind("mousedown",function(a){setTimeout(function(){b.wrapper.trigger("focus")},1),GENTICS.Aloha.TableHelper.unselectCells(),a.stopPropagation()}),this.obj.get(0).onselectstart=function(a){return!1},this.wrapper=this.obj.children(),this.wrapper.get(0).onselectstart=function(){window.event.cancelBubble=!0},this},GENTICS.Aloha.Table.Cell.prototype.deactivate=function(){var a=this.obj.children(".GENTICS_Table_Cell_editable");a.length&&(a.contents().unwrap(),a.unbind(),a.remove(),this.obj.unbind("click"),GENTICS.Aloha.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class"))},GENTICS.Aloha.Table.Cell.prototype.toString=function(){return"GENTICS.Aloha.Table.Cell"},GENTICS.Aloha.Table.Cell.prototype.selectAll=function(a){var b=a.jquery?a.get(0):a;if(!jQuery.browser.msie){var c=window.getSelection();if(c.setBaseAndExtent)c.setBaseAndExtent(b,0,b,b.innerText.length-1);else{window.opera&&b.innerHTML.substring(b.innerHTML.length-4)=="<BR>"&&(b.innerHTML=b.innerHTML+"&#160;");var d=document.createRange();d.selectNodeContents(b),c.removeAllRanges(),c.addRange(d)}}else if(document.getSelection){var c=document.getSelection(),d=document.createRange();d.selectNodeContents(b),c.removeAllRanges(),c.addRange(d)}else if(document.selection){var d=document.body.createTextRange();d.moveToElementText(b),d.select()}GENTICS.Aloha.Selection.updateSelection(a)},GENTICS.Aloha.Table.Cell.prototype.editableMouseDown=function(a){GENTICS.Aloha.TableHelper.unselectCells(),this.tableObj.hasFocus&&a.stopPropagation()},GENTICS.Aloha.Table.Cell.prototype.editableKeyUp=function(a){this.checkForEmptyEvent(a)},GENTICS.Aloha.Table.Cell.prototype.editableKeyDown=function(a){this.checkForEmptyEvent(a);if(!a.ctrlKey&&!a.shiftKey)GENTICS.Aloha.TableHelper.selectedCells.length>0&&GENTICS.Aloha.TableHelper.selectedCells[0].length>0&&(GENTICS.Aloha.TableHelper.selectedCells[0][0].firstChild.focus(),GENTICS.Aloha.TableHelper.unselectCells(),a.stopPropagation());else if(a.shiftKey&&GENTICS.Aloha.TableHelper.selectedCells.length>0){var b=37,c=38,d=39,e=40;switch(GENTICS.Aloha.TableHelper.selectionType){case"row":switch(a.keyCode){case c:var f=GENTICS.Aloha.TableHelper.selectedCells[0][0].parentNode.rowIndex;f>1&&this.tableObj.rowsToSelect.push(f-1);break;case e:var g=GENTICS.Aloha.TableHelper.selectedCells.length-1,h=GENTICS.Aloha.TableHelper.selectedCells[g][0].parentNode.rowIndex;h<this.tableObj.numRows&&this.tableObj.rowsToSelect.push(h+1)}this.tableObj.selectRows();break;case"column":switch(a.keyCode){case b:var i=GENTICS.Aloha.TableHelper.selectedCells[0][0].cellIndex;i>1&&this.tableObj.columnsToSelect.push(i-1);break;case d:var j=GENTICS.Aloha.TableHelper.selectedCells[0].length-1,k=GENTICS.Aloha.TableHelper.selectedCells[0][j].cellIndex;k<this.tableObj.numCols&&this.tableObj.columnsToSelect.push(k+1)}this.tableObj.selectColumns()}return a.stopPropagation(),a.preventDefault(),!1}},GENTICS.Aloha.Table.Cell.prototype.checkForEmptyEvent=function(a){if(jQuery(this.wrapper).children().length>0)return;var b=this.wrapper.text();b==""&&(this.wrapper.text(" "),this.wrapper.get(0).blur(),this.wrapper.get(0).focus())},GENTICS.Aloha.Table.CreateLayer=function(){},GENTICS.Aloha.Table.CreateLayer.prototype.parameters={elemId:"GENTICS_Aloha_Table_createLayer",className:"GENTICS_Table_Createdialog",numX:10,numY:10,layer:undefined,target:undefined},GENTICS.Aloha.Table.CreateLayer.prototype.config=new Object,GENTICS.Aloha.Table.CreateLayer.prototype.visible=!1,GENTICS.Aloha.Table.CreateLayer.prototype.show=function(){var a=this.get("layer");a==null?this.create():(this.setPosition(a),a.find("td").removeClass("hover"),a.show()),this.visible=!0},GENTICS.Aloha.Table.CreateLayer.prototype.create=function(){var a=this,b=jQuery("<div></div>");b.id=this.get("elemId"),b.addClass(this.get("className"));var c=jQuery("<table></table>");c.css("width",(this.get("numX")+6)*15);var d,e;for(var f=0;f<this.get("numY");f++){d=jQuery("<tr></tr>");for(var g=0;g<this.get("numX");g++)e=jQuery("<td> </td>"),f==0&&g==0&&e.addClass("hover"),e.bind("mouseover",{rowId:f,colId:g},function(b){a.handleMouseOver(b,c)}),e.bind("click",{rowId:f,colId:g},function(b){var c=b.data.rowId+1,d=b.data.colId+1;GENTICS.Aloha.TablePlugin.createTable(d,c),a.hide()}),d.append(e);c.append(d)}b.append(c),this.set("layer",b),this.setPosition(),b.bind("click",function(a){a.stopPropagation()}).mousedown(function(a){a.stopPropagation()}),jQuery("body").append(b).bind("click",function(b){b.target!=a.get("target")&&a.visible&&a.hide()
})},GENTICS.Aloha.Table.CreateLayer.prototype.handleMouseOver=function(a,b){var c=a.data.rowId,d=a.data.colId,e=b.find("tr");for(var f=0;f<=e.length;f++){var g=jQuery(e[f]).find("td");for(var h=0;h<=g.length;h++)f<=c&&h<=d?jQuery(g[h]).addClass("hover"):jQuery(g[h]).removeClass("hover")}},GENTICS.Aloha.Table.CreateLayer.prototype.setPosition=function(){var a=jQuery(this.get("target")),b=a.offset();this.get("layer").css("left",b.left+"px"),this.get("layer").css("top",b.top+a.height()+"px")},GENTICS.Aloha.Table.CreateLayer.prototype.hide=function(){this.get("layer").hide(),this.visible=!1},GENTICS.Aloha.Table.CreateLayer.prototype.get=function(a){return this.config[a]?this.config[a]:this.parameters[a]?this.parameters[a]:undefined},GENTICS.Aloha.Table.CreateLayer.prototype.set=function(a,b){this.config[a]?this.config[a]=b:this.parameters[a]=b},GENTICS.Aloha.TableHelper=function(){},GENTICS.Aloha.TableHelper.prototype.selectionType=undefined,GENTICS.Aloha.TableHelper.prototype.selectedCells=[],GENTICS.Aloha.TableHelper.prototype.unselectCells=function(){if(this.selectedCells.length>0){for(var a=0;a<this.selectedCells.length;a++)jQuery(this.selectedCells[a]).removeClass(GENTICS.Aloha.TablePlugin.get("classCellSelected"));this.selectedCells=[],this.selectionType=undefined}},GENTICS.Aloha.TableHelper.prototype.getNewTableID=function(){var a="GENTICS_Table_",b=1e6;for(this.tableCounter;!0;this.tableCounter++){var c=a+Math.ceil(Math.random()*b);for(var d=c.length;d<a.length+b.toString().length;d++)c+="0";if(!jQuery("#"+c).length)return c}},GENTICS.Aloha.TableHelper=new GENTICS.Aloha.TableHelper