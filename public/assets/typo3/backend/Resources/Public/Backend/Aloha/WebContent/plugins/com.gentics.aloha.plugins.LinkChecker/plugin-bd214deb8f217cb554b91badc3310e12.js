/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
GENTICS.Aloha.LinkChecker=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.LinkChecker"),GENTICS.Aloha.LinkChecker.languages=["en"],GENTICS.Aloha.LinkChecker.errorCodes=[400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,422,423,424,425,426,449,450,500,501,502,503,504,505,506,507,509,510],GENTICS.Aloha.LinkChecker.warningCodes=[404,411,412,413,426,449,450,500,503,504,505,507,509,510],GENTICS.Aloha.LinkChecker.init=function(){this.proxyUrl=null,GENTICS.Aloha.LinkChecker.settings.proxyUrl!=undefined&&(this.proxyUrl=GENTICS.Aloha.LinkChecker.settings.proxyUrl),this.timer={},this.xhr={};var a=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableActivated",function(b,c){c.editable.obj.find("a").each(function(){a.checkLink(this,jQuery(this).attr("href"),0)})}),GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableDeactivated",function(b,c){a.makeClean(c.editable.obj)}),GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"hrefChanged",function(b,c){a.checkLink(c.obj,"hrefChanged")})},GENTICS.Aloha.LinkChecker.checkLink=function(a,b,c,d){var e=this,f=jQuery(a).attr("href"),g=f;if(typeof f=="string"&&!/^http/.test(f.toLowerCase())){this.makeCleanLink(a);return}this.proxyUrl&&(f=this.proxyUrl+f),this.xhr[b]&&(this.xhr[b].abort(),this.xhr[b]=undefined),this.timer[b]=this.urlExists(f,function(b){e.makeCleanLink(a)},function(b){if(a){if(jQuery.inArray(b.status,e.errorCodes)>=0)var c=b.status;else var c="0";var d=jQuery(a);d.attr("title")&&!d.attr("data-invalid")&&d.attr("data-title",d.attr("title")),d.attr("data-invalid","true"),d.attr("title",g+". "+e.i18n("error."+c)),jQuery.inArray(b.status,e.warningCodes)>=0?d.addClass("GENTICS_link_warn"):d.addClass("GENTICS_link_error")}},b,d,c)},GENTICS.Aloha.LinkChecker.urlExists=function(a,b,c,d,e,f){var g=this;clearTimeout(this.timer[d]),f=f!=null&&f!=undefined?f:700;var h=setTimeout(function(){g.xhr[d]=jQuery.ajax({url:a,timeout:e?1e4:e,type:"HEAD",complete:function(a){clearTimeout(h);try{a.status<400?b.call(this,a):c.call(this,a)}catch(d){c.call(this,{status:0})}}})},f);return h},GENTICS.Aloha.LinkChecker.makeCleanLink=function(a){if(a){var b=jQuery(a);b.attr("data-title")?b.attr("title",b.attr("data-title")):b.removeAttr("title"),b.removeAttr("data-title"),b.removeAttr("data-invalid"),b.removeClass("GENTICS_link_error"),b.removeClass("GENTICS_link_warn")}},GENTICS.Aloha.LinkChecker.makeClean=function(a){var b=this;a.find("a").each(function(){b.makeCleanLink(this)})},GENTICS.Aloha.LinkChecker.urlencode=function(a){return a=(a+"").toString(),encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}