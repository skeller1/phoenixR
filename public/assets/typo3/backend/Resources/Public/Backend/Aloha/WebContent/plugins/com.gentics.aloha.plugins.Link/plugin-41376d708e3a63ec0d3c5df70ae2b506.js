/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
/**
 * register the plugin with unique name
 */
GENTICS.Aloha.Link=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.Link"),GENTICS.Aloha.Link.languages=["en","de","fr","ru","pl"],GENTICS.Aloha.Link.config=["a"],GENTICS.Aloha.Link.targetregex="",GENTICS.Aloha.Link.target="",GENTICS.Aloha.Link.cssclassregex="",GENTICS.Aloha.Link.cssclass="",GENTICS.Aloha.Link.objectTypeFilter=[],GENTICS.Aloha.Link.onHrefChange=null,GENTICS.Aloha.Link.init=function(){GENTICS.Aloha.Link.settings.targetregex!=undefined&&(GENTICS.Aloha.Link.targetregex=GENTICS.Aloha.Link.settings.targetregex),GENTICS.Aloha.Link.settings.target!=undefined&&(GENTICS.Aloha.Link.target=GENTICS.Aloha.Link.settings.target),GENTICS.Aloha.Link.settings.cssclassregex!=undefined&&(GENTICS.Aloha.Link.cssclassregex=GENTICS.Aloha.Link.settings.cssclassregex),GENTICS.Aloha.Link.settings.cssclass!=undefined&&(GENTICS.Aloha.Link.cssclass=GENTICS.Aloha.Link.settings.cssclass),GENTICS.Aloha.Link.settings.objectTypeFilter!=undefined&&(GENTICS.Aloha.Link.objectTypeFilter=GENTICS.Aloha.Link.settings.objectTypeFilter),GENTICS.Aloha.Link.settings.onHrefChange!=undefined&&(GENTICS.Aloha.Link.onHrefChange=GENTICS.Aloha.Link.settings.onHrefChange),this.createButtons(),this.subscribeEvents(),this.bindInteractions()},GENTICS.Aloha.Link.createButtons=function(){var a=this;this.formatLinkButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_a",size:"small",onclick:function(){a.formatLink()},tooltip:this.i18n("button.addlink.tooltip"),toggle:!0}),GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.formatLinkButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.format"),1),this.insertLinkButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_a",size:"small",onclick:function(){a.insertLink(!1)},tooltip:this.i18n("button.addlink.tooltip"),toggle:!1}),GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.insertLinkButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1),GENTICS.Aloha.FloatingMenu.createScope(this.getUID("link"),"GENTICS.Aloha.continuoustext"),this.browser=new GENTICS.Aloha.ui.Browser,this.browser.setObjectTypeFilter(GENTICS.Aloha.Link.objectTypeFilter),this.browser.onSelect=function(b){a.hrefField.setItem(b),a.hrefChange()},this.repositoryButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button_big GENTICS_button_tree",size:"large",onclick:function(){a.browser.show()},tooltip:this.i18n("button.addlink.tooltip"),toggle:!1}),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("link"),this.repositoryButton,this.i18n("floatingmenu.tab.link"),1),this.hrefField=new GENTICS.Aloha.ui.AttributeField({width:320,valueField:"url"}),this.hrefField.setTemplate("<span><b>{name}</b><br/>{url}</span>"),this.hrefField.setObjectTypeFilter(GENTICS.Aloha.Link.objectTypeFilter),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("link"),this.hrefField,this.i18n("floatingmenu.tab.link"),1),this.removeLinkButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_a_remove",size:"small",onclick:function(){a.removeLink()},tooltip:this.i18n("button.removelink.tooltip")}),GENTICS.Aloha.FloatingMenu.addButton(this.getUID("link"),this.removeLinkButton,this.i18n("floatingmenu.tab.link"),1)},GENTICS.Aloha.Link.bindInteractions=function(){var a=this;this.hrefField.addListener("keyup",function(b,c){if(c.keyCode==27){var d=a.hrefField.getQueryValue();d[0]!="/"&&!d.match(/^.*\.([a-z]){2,4}$/i)&&d[0]!="#"&&!d.match(/^htt.*/i)}a.hrefChange()}),this.hrefField.addListener("blur",function(b,c){this.getValue()==""&&a.removeLink()});for(var b=0;b<GENTICS.Aloha.editables.length;b++)GENTICS.Aloha.editables[b].obj.keydown(function(b){if(b.metaKey&&b.which==76)return a.findLinkMarkup()?(GENTICS.Aloha.FloatingMenu.userActivatedTab=a.i18n("floatingmenu.tab.link"),GENTICS.Aloha.FloatingMenu.doLayout(),a.hrefField.focus()):a.insertLink(),!1}),GENTICS.Aloha.editables[b].obj.find("a").each(function(b){jQuery(this).mouseenter(function(b){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"mouse over link."),a.mouseOverLink=this,a.updateMousePointer()}),jQuery(this).mouseleave(function(b){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"mouse left link."),a.mouseOverLink=null,a.updateMousePointer()}),jQuery(this).click(function(a){if(a.metaKey)return GENTICS.Aloha.activeEditable.blur(),setTimeout(function(){location.href=a.target},0),a.stopPropagation(),!1})});jQuery(document).keydown(function(b){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"Meta key down."),a.metaKey=b.metaKey,a.updateMousePointer()}),jQuery(document).keyup(function(b){GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"Meta key up."),a.metaKey=b.metaKey,a.updateMousePointer()})},GENTICS.Aloha.Link.updateMousePointer=function(){this.metaKey&&this.mouseOverLink?(GENTICS.Aloha.Log.debug(GENTICS.Aloha.Link,"set pointer"),jQuery(this.mouseOverLink).removeClass("GENTICS_link_text"),jQuery(this.mouseOverLink).addClass("GENTICS_link_pointer")):(jQuery(this.mouseOverLink).removeClass("GENTICS_link_pointer"),jQuery(this.mouseOverLink).addClass("GENTICS_link_text"))},GENTICS.Aloha.Link.subscribeEvents=function(){var a=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"selectionChanged",function(b,c){if(GENTICS.Aloha.activeEditable){var d=a.getEditableConfig(GENTICS.Aloha.activeEditable.obj);if(jQuery.inArray("a",d)!=-1)a.formatLinkButton.show(),a.insertLinkButton.show();else{a.formatLinkButton.hide(),a.insertLinkButton.hide();return}var e=a.findLinkMarkup(c);e?(a.insertLinkButton.hide(),a.formatLinkButton.setPressed(!0),GENTICS.Aloha.FloatingMenu.setScope(a.getUID("link")),a.hrefField.setTargetObject(e,"href")):(a.formatLinkButton.setPressed(!1),a.hrefField.setTargetObject(null)),GENTICS.Aloha.FloatingMenu.doLayout()}})},GENTICS.Aloha.Link.findLinkMarkup=function(a){if(typeof a=="undefined")var a=GENTICS.Aloha.Selection.getRangeObject();return GENTICS.Aloha.activeEditable?a.findMarkup(function(){return this.nodeName.toLowerCase()=="a"},GENTICS.Aloha.activeEditable.obj):null},GENTICS.Aloha.Link.formatLink=function(){var a=GENTICS.Aloha.Selection.getRangeObject();GENTICS.Aloha.activeEditable&&(this.findLinkMarkup(a)?this.removeLink():this.insertLink())},GENTICS.Aloha.Link.insertLink=function(a){if(this.findLinkMarkup(b))return;GENTICS.Aloha.FloatingMenu.userActivatedTab=this.i18n("floatingmenu.tab.link");var b=GENTICS.Aloha.Selection.getRangeObject();b.isCollapsed()&&a!=!1&&GENTICS.Utils.Dom.extendToWord(b);if(b.isCollapsed()){var c=this.i18n("newlink.defaulttext"),d=jQuery('<a href="">'+c+"</a>");GENTICS.Utils.Dom.insertIntoDOM(d,b,jQuery(GENTICS.Aloha.activeEditable.obj)),b.startContainer=b.endContainer=d.contents().get(0),b.startOffset=0,b.endOffset=c.length}else{var d=jQuery('<a href=""></a>');GENTICS.Utils.Dom.addMarkup(b,d,!1)}b.select(),this.hrefField.focus(),this.hrefChange()},GENTICS.Aloha.Link.removeLink=function(){var a=GENTICS.Aloha.Selection.getRangeObject(),b=this.findLinkMarkup();b&&(GENTICS.Utils.Dom.removeFromDOM(b,a,!0),GENTICS.Aloha.activeEditable.obj[0].focus(),a.select())},GENTICS.Aloha.Link.hrefChange=function(){this.hrefField.setAttribute("target",this.target,this.targetregex,this.hrefField.getQueryValue()),this.hrefField.setAttribute("class",this.cssclass,this.cssclassregex,this.hrefField.getQueryValue()),typeof this.onHrefChange=="function"&&this.onHrefChange.call(this,this.hrefField.getTargetObject(),this.hrefField.getQueryValue(),this.hrefField.getItem()),GENTICS.Aloha.EventRegistry.trigger(new GENTICS.Aloha.Event("hrefChanged",GENTICS.Aloha,{obj:this.hrefField.getTargetObject(),href:this.hrefField.getQueryValue(),item:this.hrefField.getItem()}))},GENTICS.Aloha.Link.makeClean=function(a){a.find("a").each(function(){jQuery(this).removeClass("GENTICS_link_pointer"),jQuery(this).removeClass("GENTICS_link_text")})}