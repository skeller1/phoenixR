/**
 * Problem: can't regenerate ids to reflect the heading text, because
 * that would invalidate any external links
 *
 * Some assumptions are made about the order of the elements that jQuery
 * returns. Usually, this is document order. With $.prevAll() and
 * .parents(), however, the order is reversed.
 *
 * It would be nice to have some way to register for a 'modified' event
 * on descendants of editables that were actually edited.
 *
 * How to handle dynamically registered editables?
 */
(function(){function c(a){return a[a.length-1]}function d(a){return a[0]}function e(a){return a.slice(1)}function f(a,b){return g(a,function(a){return a===b})}function g(a,b){for(var c=0;c<a.length;c++)if(b(a[c]))return a[c];return null}function h(a,b){var c=[];for(var d=0;d<a.length;d++)c.push(b(a[d]));return c}function i(a,b){h(a,b)}var a=GENTICS.Aloha.TOC||{jQuery:jQuery},b=a.jQuery,j="com.gentics.aloha.plugins.TOC",k=GENTICS.Aloha.TOC=new GENTICS.Aloha.Plugin(j);GENTICS.Aloha.TOC.languages=["en","de"];var l=null,m=[];k.init=function(){var a=k.settings;a.updateInterval=a.updateInterval||5e3,a.minEntries=a.minEntries||0,k.initButtons(),b(document).ready(function(){k.spawn()})},k.initButtons=function(){k.insertTocButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_ul",size:"small",onclick:function(){k.insertAtSelection(l)},tooltip:this.i18n("button.addtoc.tooltip"),toggle:!1}),GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.insertTocButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1)},k.register=function(a){l=a},k.generateId=function(a){var c;typeof a=="object"?c=b(a).text().replace(/[^a-zA-Z-]+/g,"-").replace(/^[^a-zA-Z]+/,""):a&&(c=a);for(var d=0;;d++){var e=c;d&&(e+="-"+d);var f=document.getElementById(e);if(!f||typeof a=="object"&&f===a)return e}},k.outline=function(a){var c=[b()],d=[c];return k.headings(a).each(function(){var a=b(this),c=this.nodeName.toLowerCase(),e=["h6","h5","h4","h3","h2","h1"],h=b.inArray(c,e),i=e.slice(h).join(","),j=a.nextUntil(i).andSelf(),k=[j],l=g(d,function(c){var d=c[0];return!d.length||g(d,function(c){return a.get(0)===c||b.contains(c,a.get(0))})});l.push(k),d.splice(0,f(d,l),k)}),c},k.editableContainers=function(){return b(h(GENTICS.Aloha.editables,function(a){return document.getElementById(a.getId())}))},k.headings=function(a){return a.find(":header").add(a.filter(":header"))},k.anchorFromLinkId=function(a,c){return c?a.find('a[href $= "#'+c+'"]'):b()},k.linkIdFromAnchor=function(a){var b=a.attr("href");return b?b.match(/#(.*?)$/)[1]:null},k.insertAtSelection=function(a){a=a||k.editableContainers();var c=k.generateId("toc"),d=b("<ol class='toc_root'></ol>").attr("id",c).attr("contentEditable","false"),e=GENTICS.Aloha.Selection.getRangeObject(),f=GENTICS.Aloha.activeEditable,g=b(document.getElementById(f.getId()));GENTICS.Utils.Dom.insertIntoDOM(d,e,g),k.create(c).register(a).update().tickTock()},k.spawn=function(a,c){a=a||b("body"),c=c||k.editableContainers(),a.find("ol.toc_root").each(function(){var a=b(this).attr("id");a||(a=k.generateId("toc"),b(this).attr("id",a)),k.create(a).register(c).tickTock()})},k.create=function(a){return m.push(this),{id:a,$containers:b(),root:function(){return b(document.getElementById(this.id))},register:function(a){var c=this;return c.$containers=c.$containers.add(a),c.$containers.filter(function(){return!b(this).data(j+"."+c.id+".listening")}).each(function(){var a=b(this);a.data(j+"."+c.id+".listening",!0),a.bind("blur",function(){c.cleanupIds(a.get(0)),c.update(a)})}),c},tickTock:function(a){var b=this;a=a||k.settings.updateInterval;if(!a)return;return window.setInterval(function(){b.register(k.editableContainers()),b.update()},a),b},cleanupIds:function(a){var c=[];return k.headings(this.$containers).each(function(){var d=b(this).attr("id");(d&&-1!=b.inArray(d,c)||a&&(b.contains(a,this)||a===this))&&b(this).attr("id",k.generateId(this)),c.push(d)}),this},update:function(a){var b=this;a=a||b.$containers;var f=k.outline(b.$containers),g=[b.root()],h=[];c(g).empty(),function l(a){var c=[];i(a,function(a){var f=d(a),h=b.linkSection(f,g,c);g.push(h),l(e(a)),g.pop(),c.push(h)})}(e(f));var j=b.root().attr("data-TOC-minEntries")||k.settings.minEntries;return b.root().find("li").length>=j?b.root().show():b.root().hide(),this},linkSection:function(a,d,e){var f=a.eq(0).attr("id");f||(f=k.generateId(a.get(0)),a.eq(0).attr("id",f));var g=this.root(),h=k.anchorFromLinkId(g,f);h.length||(h=b("<li><a/></li>")),h.find("a").attr("href","#"+f).text(a.eq(0).text());if(c(e))c(e).after(h);else if(c(d).get(0)==g.get(0))g.append(h);else{var i=b("<ol/>").append(h);c(d).append(i)}return h}}}})()